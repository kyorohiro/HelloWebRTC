<html>
<header>
<title>sample</title>
<script src="signalclient.js"></script>
<script src="caller.js"></script>
<script src="callerinfo.js"></script>
<script type="text/javascript">
<!--
var _msclient = null;
var _callerinfo = new CallerInfo();

window.onload = function() {
	var uuid = document.getElementById("uuid").textContent;
	_msclient = new SignalClient("ws://localhost:8080");
	_msclient.setOnMessage(onMessage);
}

function onPushSendJoin() {
	var uuid = document.getElementById("uuid").textContent;
	console.log("join():uuid="+uuid);
	_msclient.join(uuid);	
}

function onPushSendHello() {
    console.log("sendHello()");
    var keys = _callerinfo.keys();
    while(keys.length != 0) {
    	var key = keys.pop();
    	var _caller = _callerinfo.get(key).caller;
   	    console.log("sendHello() " + key);
    	_caller.sendHello();
    }
}

function onPushSendOffer() {
    console.log("push send button"+event.srcElement.uuid);
    var uuid = event.srcElement.value;
    sendOffer(uuid);
}


function sendOffer(uuid) {
    var _caller = new Caller(uuid);
    _callerinfo.add(uuid, _caller);
    _caller.setTargetUUID(uuid);
    _caller.setOnReceiveSDP(onReceiveSDP);
    _caller.createPeerConnection();
    _caller.createOffer();
}

function sendAnswer(uuid, sdp) {
    console.log("+++sendAnswer");
    var _caller = new Caller(uuid);
    _callerinfo.add(uuid, _caller);
	_caller.setTargetUUID(uuid);
	_caller.setOnReceiveSDP(onReceiveSDP);
    _caller.createPeerConnection();
	_caller.setRemoteSDP("offer", sdp);
	_caller.createAnswer();
}

function setRemoteSdp(type, uuid, sdp) {
	var _caller = _callerinfo.get(uuid).caller;
	_caller.setTargetUUID(uuid);
	_caller.setRemoteSDP(type, sdp);
}

//
// receive message from signal server
function onMessage(m) {
	var contentType = JSON.parse(m.data)["_contentType"];
	var sdp  =  JSON.parse(m.data)["_content"];
	var from = JSON.parse(m.data)["_from"];
	var to   = JSON.parse(m.data)["_to"];
	console.log("--onMessage()[--]"+contentType+","+to+","+from);

	if("answer"===contentType) {
		setRemoteSdp("answer", from, sdp);
	} else if("offer" === contentType) {
		// send answer
		sendAnswer(from, sdp);
	} else if("join" === contentType) {
		// create button
		var elm = document.createElement("button");
		elm.textContent = from;
		var offerList = document.getElementById("offerlist");
		elm.setAttribute("onclick", "onPushSendOffer();");
		elm.setAttribute("value", from);
		offerList.appendChild(elm);		
	}
}

//
// receive sdp info from webrtv
function onReceiveSDP(_caller, _type, sdp){
	console.log("##########");
	console.log("type="+_type+"");
	console.log(""+sdp+"");
	console.log("##########");
	var uuid = document.getElementById("uuid").textContent;
	_callerinfo.show();
	if("offer" === _type) {
		_msclient.sendOffer(_caller.getTargetUUID(), uuid, sdp);
	} else if("answer" === _type) {
		_msclient.sendAnswer(_caller.getTargetUUID(), uuid, sdp);
	}	
}


//-->
</script>
</header>
<body>
<label id="uuid">uuid_value</label><br><br>

<button id="join" onclick="onPushSendJoin();">join network(server)</button><br><br>
<button id="sendOffer" onclick="onPushSendHello();">sendHello</button><br><br>

<div id="offerlist">
<label>PeerList</label><br>
</div>

<div id="peerlist">
<label>Connected</label><br>
</div>

</body>
</html>

