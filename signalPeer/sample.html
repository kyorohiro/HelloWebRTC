<html>
<header>
<title>sample</title>
<script src="signal/signalclient.js" type="text/javascript"></script>
<script src="caller/caller.js" type="text/javascript"></script>
<script src="caller/callerinfo.js" type="text/javascript"></script>
<script src="peer/signalpeer.js" type="text/javascript"></script>
<script src="util/uuid.njs" type="text/javascript"></script>
<script src="peer/messagetransfer.js" type="text/javascript"></script>
<script src="peer/messageprotocol.js" type="text/javascript"></script>

<script type="text/javascript">
<!--
var _mSignalPeer = null;
var v = new function() {
   this.onJoinNetwork = function(peer,v) {
   		console.log("joinNetwork():------------"+v.from+"------------");
   		if(v.from === _mSignalPeer.getUUID()) {
   			return;
   		}
 		// create button
		var offerList = document.getElementById("offerlist");
		{
			var elm = document.createElement("label");
			elm.textContent = "[server] "+v.from;
			offerList.appendChild(elm);		
		}
		{
			var elm = document.createElement("br");
			offerList.appendChild(elm);
		}
 		{
			var elm = document.createElement("button");
			elm.textContent = "offer";
			elm.setAttribute("onclick", "onPushSendOffer(\"server\");");
			elm.setAttribute("value", v.from);
			offerList.appendChild(elm);
		}
		{
			var elm = document.createElement("br");
			offerList.appendChild(elm);
		}
 		{
			var elm = document.createElement("button");
			elm.textContent = "findnode";
			elm.setAttribute("onclick", "onPushFindNode(\""+v.from+"\");");
			elm.setAttribute("value", v.from);
			offerList.appendChild(elm);
		}
		{
			var elm = document.createElement("br");
			offerList.appendChild(elm);
		}
   };

   this.onReceiveMessage = function(peer, v) {
   		var p2pMes = JSON.parse(v);
   		console.log("onReceiveMessage:------------------------");
   		if("response" === p2pMes.type) {
	    	if("findnode" === p2pMes.command) {
 				// create button
				var elm = document.createElement("button");
				elm.textContent = "[peer"+p2pMes.from+"] "+p2pMes.node["node0"];
				var offerList = document.getElementById("offerlist");
				elm.setAttribute("onclick", "onPushSendOffer(\""+p2pMes.from+"\");");
				elm.setAttribute("value", v.from);
				offerList.appendChild(elm);
	    	}
	    }
   };
};

window.onload = function() {
	_mSignalPeer = new SignalPeer("ws://localhost:8080");
	_mSignalPeer.setEventListener(v);
}

function onPushSendJoin() {
	console.log("onPushSendJoin()");
    _mSignalPeer.joinNetwork();
}

function onPushSendOffer(type) {
    console.log("onPushSendOffer()"+event.srcElement.value+","+type);
    var uuid = event.srcElement.value;
    if("server" == type) { 
    	_mSignalPeer.sendOffer(uuid);
    } else {
    	_mSignalPeer.sendOffer(uuid);    	
    }
}

function onPushFindNode(uuid) {
    console.log("onPushFindNode():"+uuid);
    _mSignalPeer.getMessageProtocol().sendFindNode(uuid);
}


function onPushSendHello() {
    console.log("onPushSendHello()");
    _mSignalPeer.sendHello(JSON.stringify(v));
}


//-->
</script>
</header>
<body>
<label id="uuid">uuid_value</label><br><br>
<button id="join" onclick="onPushSendJoin();">join network(server)</button><br><br>
<button id="hello" onclick="onPushSendHello();">sendHello</button><br><br>

<br>
<div id="offerlist">
<h3>[PeerList]</h3>
</div>


</body>
</html>

